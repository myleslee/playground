## 2015 年 12 月 1 日：云引擎服务故障通告

12 月 1 日傍晚将近 6 点有用户反馈云引擎服务异常，部分请求出现 502 应答。我们工程师立刻上线排查，最终确认是平台的问题，并及时进行了修复，在故障发生的一小时后将云引擎服务恢复正常。此次故障影响到所有使用了国内节点的云引擎用户，我们在此致歉，并附上故障的详细报告和措施。

## 故障时间
12 月 1 日 17 点 41 分 至同日 18 点 43 分（持续 1 小时 2 分钟）

## 影响范围

国内节点的所有云引擎应用出现间歇性 502 响应，没有使用云引擎的应用不受影响。

## 故障原因

先介绍一下云引擎的前端架构。我们使用「容器」技术来实现云引擎的弹性扩展。从客户端发到云引擎的所有请求都是先交由负载均衡服务器处理，然后途径路由服务器（负责将请求动态匹配到正确的 docker 节点），最后到达各个应用节点来进行实际处理。

在我们的平台上，目前有一个应用使用了云引擎＋ WebSocket 的组合方式来实现自己的业务逻辑。在这次故障发生的时候，该应用的 WebSocket 出现了大量的连接异常。由于我们的路由服务器对 WebSocket 的异常处理存在缺陷，所以导致路由服务进程异常退出，而该服务随即又被我们的监控修复程序重新启动，然后再次接收到 WebSocket 异常请求而退出，如此反复。在此过程中，来自其他应用的请求会因为路由服务的重启而间歇性地出现 502 错误响应。

## 后续措施

1. 增强路由服务的[鲁棒性](http://baike.baidu.com/view/45520.htm)，完善对 WebSocket 的异常处理（已完成）；
2. 加强路由服务进程的主动监控，力争第一时间发现问题（待做）。

如果您对此次故障有任何疑问，请发邮件至 <ops@leancloud.cn> 与我们联系。
